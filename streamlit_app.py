import streamlit as st
import joblib
import pandas as pd
import plotly.express as px

import folium
from streamlit_folium import st_folium
from PIL import Image

# Set up the page configuration
st.set_page_config(page_title="ููุญุฉ ุงููุนูููุงุช ุงูุนูุงุฑูุฉ ", layout="wide", initial_sidebar_state="collapsed")

# Custom CSS for styling
st.markdown("""
<style>
.stApp {
    background-color: #f0f2f6;
}
.stButton>button {
    color: #ffffff;
    background-color: #4CAF50;
    border-radius: 5px;
}
.stMetricLabel {
    font-size: 20px;
}
.stMetricValue {
    font-size: 40px;
    color: #4CAF50;
}
</style>
""", unsafe_allow_html=True)

@st.cache_resource
def load_model():
    return joblib.load("lgbm.joblib")

model = load_model()

# Relevant features for prediction
relevant_features = [
    'beds', 'livings', 'wc', 'area', 'street_width', 'age', 'street_direction', 'ketchen',
    'furnished', 'location.lat', 'location.lng', 'city_id', 'district_id'
]

# Prediction function
def predict_price(new_record):
    new_record_df = pd.DataFrame([new_record])
    new_record_df = pd.get_dummies(new_record_df, drop_first=True)
    new_record_df = new_record_df.reindex(columns=relevant_features, fill_value=0)
    return model.predict(new_record_df)[0]

# Initialize session state for location
if 'location_lat' not in st.session_state:
    st.session_state['location_lat'] = 24.7136
if 'location_lng' not in st.session_state:
    st.session_state['location_lng'] = 46.6753

# Main application
st.title("๐  ููุญุฉ ุงููุนูููุงุช ุงูุนูุงุฑูุฉ  ")

# Create layout for the dashboard
col1, col2 = st.columns(2)

# Column 1: Map and Location Selection
with col1:
    st.subheader("๐ ุงุฎุชุฑ ุงููููุน")
    # Folium map
    m = folium.Map(location=[st.session_state['location_lat'], st.session_state['location_lng']], zoom_start=6)
    marker = folium.Marker(
        location=[st.session_state['location_lat'], st.session_state['location_lng']],
        draggable=True
    )
    marker.add_to(m)
    map_data = st_folium(m, width=700, height=400)
    if map_data['last_clicked']:
        st.session_state['location_lat'] = map_data['last_clicked']['lat']
        st.session_state['location_lng'] = map_data['last_clicked']['lng']
    st.write(f"ุงููููุน ุงููุญุฏุฏ: {st.session_state['location_lat']:.4f}, {st.session_state['location_lng']:.4f}")

# Column 2: Input Form
with col2:
    st.subheader("๐ ุฃุฏุฎู ุชูุงุตูู ุงูููุฒู")
    # Manual location input
   # st.subheader("๐ ุฅุฏุฎุงู ุงููููุน ูุฏูููุง")
     # manual_lat = st.number_input("ุฃุฏุฎู ุฎุท ุงูุนุฑุถ:", value=st.session_state['location_lat'], format="%.6f")
   # manual_lng = st.number_input("ุฃุฏุฎู ุฎุท ุงูุทูู:", value=st.session_state['location_lng'], format="%.6f")
   # if manual_lat and manual_lng:
        #st.session_state['location_lat'] = manual_lat
        #st.session_state['location_lng'] = manual_lng
        #st.write(f"ุงููููุน ุงููุฏุฎู ูุฏูููุง: {manual_lat:.4f}, {manual_lng:.4f}")

    # Create a form for house details
    with st.form("house_details_form"):
        # Create uniform input fields
        col_a, col_b = st.columns(2)
        with col_a:
            beds = st.slider("ุนุฏุฏ ุบุฑู ุงูููู ๐๏ธ", 3, 7, 3)
            livings = st.slider("ุนุฏุฏ ุบุฑู ุงููุนูุดุฉ ๐๏ธ", 1, 7, 1)
            wc = st.slider(" ุนุฏุฏ ุฏูุฑุงุช ุงูููุงู ๐ฝ", 2, 5, 2)
            area = st.number_input("ุงููุณุงุญุฉ (ูุชุฑ ูุฑุจุน) ๐", 150.0, 12000.0, 150.0)
        with col_b:
            # Replace the existing street_width input with a selectbox
            street_width = st.selectbox("ุนุฑุถ ุงูุดุงุฑุน (ูุชุฑ) ๐ฃ๏ธ", [10, 12, 15, 18, 20, 25], index=2)  # Default to 20


            age = st.number_input(" ุนูุฑ ุงูุนูุงุฑ ๐๏ธ", 0, 36, 5)
            street_direction = st.selectbox(" ููุน ุงููุงุฌูุฉ ๐งญ", [
    " ูุงุฌูุฉ ุดูุงููุฉ",
    " ูุงุฌูุฉ ุดุฑููุฉ",
    " ูุงุฌูุฉ ุบุฑุจูุฉ",
    " ูุงุฌูุฉ ุฌููุจูุฉ",
    " ูุงุฌูุฉ ุดูุงููุฉ ุดุฑููุฉ",
    " ูุงุฌูุฉ ุฌููุจูุฉ ุดุฑููุฉ",
    " ูุงุฌูุฉ ุฌููุจูุฉ ุบุฑุจูุฉ",
    " ูุงุฌูุฉ ุดูุงููุฉ ุบุฑุจูุฉ",
    " ุงูููุฉ ุชูุน ุนูู ุซูุงุซุฉ ุดูุงุฑุน",
    " ุงูููุฉ ุชูุน ุนูู ุฃุฑุจุนุฉ ุดูุงุฑุน"
])



            ketchen = st.selectbox("ูุฌูุฏ ุงููุทุจุฎ ๐ณ", [0, 1], format_func=lambda x: "ูุนู" if x == 1 else "ูุง")
            furnished = st.selectbox("ุงูููุฉ ูุคุซุซุฉ ๐ช", [0, 1], format_func=lambda x: "ูุนู" if x == 1 else "ูุง")

        # District selection
        city_name_to_id = {
                        'ุงูุฑูุงุถ': 66        }
        district_data = [
 
    (470, 'ุญู ุงูุณููุฏู', 'ุงูุฑูุงุถ'),
    (692, 'ุญู ุนุชููุฉ', 'ุงูุฑูุงุถ'),
        (474, 'ุญู ุงูุดุฑููุฉ', 'ุงูุฑูุงุถ'),
        (606, 'ุญู ุงููุณูู ุงูุบุฑุจู', 'ุงูุฑูุงุถ'),
       (590, 'ุญู ุงููููุณูุฉ', 'ุงูุฑูุงุถ'),
   
    (448, 'ุญู ุงูุฑูุงูุฉ', 'ุงูุฑูุงุถ'),
        (514, 'ุญู ุงูุบุฏูุฑ', 'ุงูุฑูุงุถ'),
    (718, 'ุญู ููุงุฑ', 'ุงูุฑูุงุถ'),
       (622, 'ุญู ุงููุงุฏู', 'ุงูุฑูุงุถ'),
    (616, 'ุญู ุงูููุฑ', 'ุงูุฑูุงุถ'),
       (542, 'ุญู ุงููุฑุจุน', 'ุงูุฑูุงุถ'),
       (416, 'ุญู ุงูุญูุฑุงุก', 'ุงูุฑูุงุถ'),
    
    (504, 'ุญู ุงูุนููู', 'ุงูุฑูุงุถ'),
   
    (604, 'ุญู ุงููุณูู ุงูุดุฑูู', 'ุงูุฑูุงุถ'),
        (568, 'ุญู ุงูููุฒ', 'ุงูุฑูุงุถ'),
    
    (548, 'ุญู ุงููุฑูุฌ', 'ุงูุฑูุงุถ'),
       (658, 'ุญู ุฌุงูุนุฉ ุงูููู ุณุนูุฏ', 'ุงูุฑูุงุถ'),
   
    (424, 'ุญู ุงูุฏุงุฑ ุงูุจูุถุงุก', 'ุงูุฑูุงุถ'),
        (492, 'ุญู ุงูุถุจุงุท', 'ุงูุฑูุงุถ'),
       
    (688, 'ุญู ุธูุฑุฉ ูุจู', 'ุงูุฑูุงุถ'),
        (532, 'ุญู ุงููุฏุณ', 'ุงูุฑูุงุถ'),
    
    (496, 'ุญู ุงูุนุฑูุฌุงุก', 'ุงูุฑูุงุถ'),
        (418, 'ุญู ุงูุฎุงูุฏูุฉ', 'ุงูุฑูุงุถ'),
    (436, 'ุญู ุงูุฑุงุฆุฏ', 'ุงูุฑูุงุถ'),
        (612, 'ุญู ุงููููุฐุฌูุฉ', 'ุงูุฑูุงุถ'),
        (410, 'ุญู ุงูุฌูุงุฏุฑูุฉ', 'ุงูุฑูุงุถ'),
    (682, 'ุญู ุทููู', 'ุงูุฑูุงุถ'),
        (510, 'ุญู ุงูุนูู', 'ุงูุฑูุงุถ'),
        (706, 'ุญู ูุฑุทุจุฉ', 'ุงูุฑูุงุถ'),
    (588, 'ุญู ุงูููุฏูุฉ', 'ุงูุฑูุงุถ'),
    (690, 'ุญู ุธูุฑุฉ ููุงุฑ', 'ุงูุฑูุงุถ'),
    (536, 'ุญู ุงูููุฑูุงู', 'ุงูุฑูุงุถ'),
        (644, 'ุญู ุงู ุณููู', 'ุงูุฑูุงุถ'),
    (516, 'ุญู ุงูุบูุงููุฉ', 'ุงูุฑูุงุถ'),
        (716, 'ุญู ููููุญุฉ ุงูุฌุฏูุฏุฉ', 'ุงูุฑูุงุถ'),
        (530, 'ุญู ุงููุงุฏุณูุฉ', 'ุงูุฑูุงุถ'),
        (554, 'ุญู ุงููุตูุงุฉ', 'ุงูุฑูุงุถ'),
       (398, 'ุญู ุงูุจุฏูุนุฉ', 'ุงูุฑูุงุถ'),
       (582, 'ุญู ุงูููุงุฑ', 'ุงูุฑูุงุถ'),
    (662, 'ุญู ุฌุฑูุฑ', 'ุงูุฑูุงุถ'),
        (566, 'ุญู ุงููุบุฑุฒุงุช', 'ุงูุฑูุงุถ'),
    (526, 'ุญู ุงูููุญุงุก', 'ุงูุฑูุงุถ'),
       (714, 'ุญู ููููุญุฉ', 'ุงูุฑูุงุถ'),
        (586, 'ุญู ุงูููุตูุฑูุฉ', 'ุงูุฑูุงุถ'),
        (442, 'ุญู ุงูุฑุญูุงููุฉ', 'ุงูุฑูุงุถ'),
        (392, 'ุญู ุงูุงุฒุฏูุงุฑ', 'ุงูุฑูุงุถ'),
    (574, 'ุญู ุงูููู ุนุจุฏุงููู', 'ุงูุฑูุงุถ'),
    (684, 'ุญู ุทูุจุฉ', 'ุงูุฑูุงุถ'),
   
    (488, 'ุญู ุงูุตูุง', 'ุงูุฑูุงุถ'),
    (708, 'ุญู ูุจู', 'ุงูุฑูุงุถ'),
        (646, 'ุญู ุฃุญุฏ', 'ุงูุฑูุงุถ'),
        (520, 'ุญู ุงููุงุฑูู', 'ุงูุฑูุงุถ'),
        (698, 'ุญู ุนูุงุธ', 'ุงูุฑูุงุถ'),
    (614, 'ุญู ุงูููุถุฉ', 'ุงูุฑูุงุถ'),
       (572, 'ุญู ุงูููู ุนุจุฏุงูุนุฒูุฒ', 'ุงูุฑูุงุถ'),
       (578, 'ุญู ุงูููู ููุตู', 'ุงูุฑูุงุถ'),
       (458, 'ุญู ุงูุฒูุฑุฉ', 'ุงูุฑูุงุถ'),
  
    (712, 'ุญู ูุทุงุฑ ุงูููู ุฎุงูุฏ ุงูุฏููู', 'ุงูุฑูุงุถ'),
  
    (672, 'ุญู ุณูุทุงูุฉ', 'ุงูุฑูุงุถ'),
    (618, 'ุญู ุงููุฏุง', 'ุงูุฑูุงุถ'),
    (524, 'ุญู ุงูููุทุฉ', 'ุงูุฑูุงุถ'),
    (518, 'ุญู ุงููุงุฎุฑูุฉ', 'ุงูุฑูุงุถ'),
    (506, 'ุญู ุงูุนููุง', 'ุงูุฑูุงุถ'),
        (674, 'ุญู ุดุจุฑุง', 'ุงูุฑูุงุถ'),
    (444, 'ุญู ุงูุฑููุนุฉ', 'ุงูุฑูุงุถ'),
       (404, 'ุญู ุงูุชุนุงูู', 'ุงูุฑูุงุถ'),
       (592, 'ุญู ุงููุคุชูุฑุงุช', 'ุงูุฑูุงุถ'),
    
    (450, 'ุญู ุงูุฑูุงุจู', 'ุงูุฑูุงุถ'),
    (422, 'ุญู ุงูุฎููุฌ', 'ุงูุฑูุงุถ'),
    (632, 'ุญู ุงููุงุณููู', 'ุงูุฑูุงุถ'),
       (558, 'ุญู ุงููุนุฐุฑ', 'ุงูุฑูุงุถ'),
    (624, 'ุญู ุงููุฑูุฏ', 'ุงูุฑูุงุถ'),
       (546, 'ุญู ุงููุฑูุฉ', 'ุงูุฑูุงุถ'),
    (478, 'ุญู ุงูุดูุง', 'ุงูุฑูุงุถ'),
    (396, 'ุญู ุงูุงูุฏูุณ', 'ุงูุฑูุงุถ'),
    (494, 'ุญู ุงูุนุงุฑุถ', 'ุงูุฑูุงุถ'),
        (598, 'ุญู ุงููุฏู', 'ุงูุฑูุงุถ'),
       (446, 'ุญู ุงูุฑูุงู', 'ุงูุฑูุงุถ'),
        (676, 'ุญู ุตูุงุญ ุงูุฏูู', 'ุงูุฑูุงุถ'),
       (502, 'ุญู ุงูุนุฒูุฒูุฉ', 'ุงูุฑูุงุถ'),
    (602, 'ุญู ุงููุฒูุฉ', 'ุงูุฑูุงุถ'),
       (570, 'ุญู ุงููููุง', 'ุงูุฑูุงุถ'),
    (620, 'ุญู ุงููุงุญุฉ', 'ุงูุฑูุงุถ'),
    
    (680, 'ุญู ุถุงุญูุฉ ููุงุฑ', 'ุงูุฑูุงุถ'),
    (420, 'ุญู ุงูุฎุฒุงูู', 'ุงูุฑูุงุถ'),
       (456, 'ุญู ุงูุฒูุฑุงุก', 'ุงูุฑูุงุถ'),
    (710, 'ุญู ูุฑูุฒ ุงูููู ุนุจุฏุงููู ููุฏุฑุงุณุงุช ูุงูุจุญูุซ', 'ุงูุฑูุงุถ'),
       (428, 'ุญู ุงูุฏุฑููููุฉ', 'ุงูุฑูุงุถ'),
       (464, 'ุญู ุงูุณูุงู', 'ุงูุฑูุงุถ'),
        (564, 'ุญู ุงููุนูุฒูุฉ', 'ุงูุฑูุงุถ'),
    (522, 'ุญู ุงูููุงุญ', 'ุงูุฑูุงุถ'),
        (560, 'ุญู ุงููุนุฐุฑ ุงูุดูุงูู', 'ุงูุฑูุงุถ'),
       (538, 'ุญู ุงููุญูุฏูุฉ', 'ุงูุฑูุงุถ'),
    
    (528, 'ุญู ุงูููุตููุฉ', 'ุงูุฑูุงุถ'),
        (550, 'ุญู ุงููุดุงุนู', 'ุงูุฑูุงุถ'),
        (694, 'ุญู ุนุฑูุฉ', 'ุงูุฑูุงุถ'),
        (668, 'ุญู ุฏูุฑุงุจ', 'ุงูุฑูุงุถ'),
    (460, 'ุญู ุงูุณุนุงุฏุฉ', 'ุงูุฑูุงุถ'),
        (696, 'ุญู ุนุฑูุถ', 'ุงูุฑูุงุถ'),
       (652, 'ุญู ุซููู', 'ุงูุฑูุงุถ'),
    (686, 'ุญู ุธูุฑุฉ ุงูุจุฏูุนุฉ', 'ุงูุฑูุงุถ'),
       
    (580, 'ุญู ุงูููุงุฎ', 'ุงูุฑูุงุถ'),
    
    (656, 'ุญู ุฌุงูุนุฉ ุงูุฃููุฑุฉ ููุฑุฉ', 'ุงูุฑูุงุถ'),
    (400, 'ุญู ุงูุจุฑูุฉ', 'ุงูุฑูุงุถ'),
    (640, 'ุญู ุงู ุงูุญูุงู ุงูุบุฑุจู', 'ุงูุฑูุงุถ'),
    (552, 'ุญู ุงููุตุงูุน', 'ุงูุฑูุงุถ'),
        (704, 'ุญู ุบุฑูุงุทุฉ', 'ุงูุฑูุงุถ'),
        (452, 'ุญู ุงูุฑูุถุฉ', 'ุงูุฑูุงุถ'),
        (600, 'ุญู ุงููุฑุฌุณ', 'ุงูุฑูุงุถ'),
    (654, 'ุญู ุฌุงูุนุฉ ุงูุงูุงู ูุญูุฏ ุจู ุณุนูุฏ ุงูุงุณูุงููุฉ', 'ุงูุฑูุงุถ'),
    (394, 'ุญู ุงูุงุณูุงู', 'ุงูุฑูุงุถ'),
    (482, 'ุญู ุงูุดูุฏุงุก', 'ุงูุฑูุงุถ'),
    (576, 'ุญู ุงูููู ููุฏ', 'ุงูุฑูุงุถ'),
       (486, 'ุญู ุงูุตุญุงูุฉ', 'ุงูุฑูุงุถ'),
    (666, 'ุญู ุฎุดู ุงูุนุงู', 'ุงูุฑูุงุถ'),
        (626, 'ุญู ุงููุฒุงุฑุงุช', 'ุงูุฑูุงุถ'),
        (440, 'ุญู ุงูุฑุจูุน', 'ุงูุฑูุงุถ'),
    (650, 'ุญู ุจูุจุงู', 'ุงูุฑูุงุถ'),
       (466, 'ุญู ุงูุณูู', 'ุงูุฑูุงุถ'),
   
    (584, 'ุญู ุงูููุตูุฑุฉ', 'ุงูุฑูุงุถ'),
    (438, 'ุญู ุงูุฑุจูุฉ', 'ุงูุฑูุงุถ'),
    
    (408, 'ุญู ุงูุฌุฒูุฑุฉ', 'ุงูุฑูุงุถ'),
        (608, 'ุญู ุงููุธูู', 'ุงูุฑูุงุถ'),
    (596, 'ุญู ุงููุฎูู', 'ุงูุฑูุงุถ'),
    (390, 'ุญู ุงุดุจูููุฉ', 'ุงูุฑูุงุถ'),
    (412, 'ุญู ุงูุญุงุฆุฑ', 'ุงูุฑูุงุถ'),
    (1326, 'ุญู ูุฏููุฉ ุงูุนูุงู', 'ุงูุฏูุงู'),
    (406, 'ุญู ุงูุฌุฑุงุฏูุฉ', 'ุงูุฑูุงุถ'),
        (610, 'ุญู ุงูููู', 'ุงูุฑูุงุถ'),
    (476, 'ุญู ุงูุดุฑู', 'ุงูุฑูุงุถ'),
    (648, 'ุญู ุจุฏุฑ', 'ุงูุฑูุงุถ'),
        (544, 'ุญู ุงููุฑุณูุงุช', 'ุงูุฑูุงุถ'),
    (472, 'ุญู ุงูุณููุฏู ุงูุบุฑุจู', 'ุงูุฑูุงุถ'),
    
    (636, 'ุญู ุงูููุงูุฉ', 'ุงูุฑูุงุถ'),
    (540, 'ุญู ุงููุฏููุฉ ุงูุตูุงุนูุฉ ุงูุฌุฏูุฏุฉ', 'ุงูุฑูุงุถ'),
    (454, 'ุญู ุงูุฑูุงู', 'ุงูุฑูุงุถ'),
       (634, 'ุญู ุงููุฑููู', 'ุงูุฑูุงุถ'),
    (556, 'ุญู ุงููุตูู', 'ุงูุฑูุงุถ'),
  
    (660, 'ุญู ุฌุจุฑุฉ', 'ุงูุฑูุงุถ'),
    (468, 'ุญู ุงูุณูููุงููุฉ', 'ุงูุฑูุงุถ'),
    (630, 'ุญู ุงููุดุงู', 'ุงูุฑูุงุถ'),
        (498, 'ุญู ุงูุนุฑูุฌุงุก ุงูุบุฑุจูุฉ', 'ุงูุฑูุงุถ'),
    (490, 'ุญู ุงูุตูุงุนูุฉ', 'ุงูุฑูุงุถ'),
    (500, 'ุญู ุงูุนุฑูุฌุงุก ุงููุณุทู', 'ุงูุฑูุงุถ'),
    (700, 'ุญู ุนููุดุฉ', 'ุงูุฑูุงุถ'),
    (702, 'ุญู ุบุจูุฑุฉ', 'ุงูุฑูุงุถ'),
    (638, 'ุญู ุงู ุงูุญูุงู ุงูุดุฑูู', 'ุงูุฑูุงุถ'),
       (664, 'ุญู ุญุทูู', 'ุงูุฑูุงุถ'),
   
    (414, 'ุญู ุงูุญุฒู', 'ุงูุฑูุงุถ'),
]
        
        selected_district = st.selectbox(
            "ุงุฎุชุฑ ุงูุญู ๐๏ธ",
            district_data,
            format_func=lambda x: f"{x[1]} ({x[2]})"
        )
        district_id = selected_district[0]
        city_id = city_name_to_id[selected_district[2]]

        # Submit button
        submitted = st.form_submit_button("๐ฎ ุชููุน ุงูุณุนุฑ")
        if submitted:
            with st.spinner('ุฌุงุฑู ุงูุญุณุงุจ...'):
                new_record = {
                    'beds': beds, 'livings': livings, 'wc': wc, 'area': area,
                    'street_width': street_width,  # Updated to be a list

                    'age': age, 'street_direction': street_direction,
                    'ketchen': ketchen, 'furnished': furnished,
                    'location.lat': st.session_state['location_lat'],
                    'location.lng': st.session_state['location_lng'],
                    'city_id': city_id, 'district_id': district_id
                }
                predicted_price = predict_price(new_record)
            st.success('ุชูุช ุนูููุฉ ุงูุชููุน ุจูุฌุงุญ!')
            st.metric(label=" ุงูุณุนุฑ ุงูุชูุฑูุจู ", value=f"ุฑูุงู {predicted_price:,.2f}")

# Bottom section: Visualization
st.header("๐ ุฑุคู")
images = ["chart1.png", "chart2.png"]
for i, img in enumerate(images, 1):
    image = Image.open(img)
    st.image(image, caption=f"ุงูุฑุณู ุงูุจูุงูู {i}", use_column_width=True)


#########################
import streamlit as st
import pandas as pd
import plotly.express as px

# Read CSV directly from Streamlit folder
file_path = "data/table2_2022.csv"  # Adjust the path based on your project structure
df = pd.read_csv(file_path, encoding="utf-8")  # Try "latin1" if UTF-8 fails

# Display DataFrame preview
st.write("ุนุฏุฏ ุงูุตููุงุช 2022", df.head())

# Create interactive Plotly bar chart
fig = px.bar(
    df,
    x=df.columns[0],  
    y=df.columns[1],  
    title="Real Estate Transactions (2022)",
    labels={"x": "ุงูุญู", "y": "ุนุฏุฏ ุงูุตููุงุช"},
    text_auto=True
)

# Show chart in Streamlit
st.plotly_chart(fig, use_container_width=True)



# Footer
st.markdown("---")

